<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Santo Rosario - Consideración de los misterios</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- PWA Manifest & Theme -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">

    <!-- Apple PWA settings -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    
    <style>
        /* Estilo personalizado para usar la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent; /* Evita el destello azul en móviles al tocar */
        }
        /* Estilo para la barra de desplazamiento */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1e293b; /* slate-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #38bdf8; /* sky-400 */
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #0ea5e9; /* sky-500 */
        }
    </style>
</head>
<body class="bg-slate-900 text-slate-200 antialiased">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-6xl pb-24"> <!-- Añadido padding-bottom para que el banner no tape el footer -->

        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-bold text-sky-400 tracking-tight">Santo Rosario</h1>
            <p class="text-slate-400 mt-2">Consideración de los misterios</p>
            <p class="text-slate-300 mt-4 max-w-3xl mx-auto text-balance">Audios breves basados en textos de san Josemaría para ayudar a hacer la consideración de los misterios del rosario.</p>
        </header>

        <!-- Reproductor de Audio Fijo -->
        <div id="audio-player-container" class="sticky top-4 z-10 bg-slate-800/50 backdrop-blur-lg p-4 rounded-xl shadow-2xl mb-8 border border-slate-700">
            <p class="text-sm text-slate-400 mb-2">Reproduciendo ahora:</p>
            <h3 id="now-playing" class="text-lg font-semibold text-white truncate">Ninguno</h3>
            <audio id="main-audio-player" controls class="w-full mt-2"></audio>
        </div>

        <!-- Grid de Misterios -->
        <main class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-6 lg:gap-8">

            <!-- Misterios Gozosos -->
            <div class="mystery-card bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col justify-center items-center border border-slate-700 transition-all duration-300 hover:border-sky-500/50">
                <button 
                    class="play-btn bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75"
                    data-src="https://raw.githubusercontent.com/gabrielbailly/considera-misterios/main/audios/gozosos.m4a"
                    data-title="Misterios Gozosos">
                    Gozosos
                </button>
            </div>

            <!-- Misterios Dolorosos -->
            <div class="mystery-card bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col justify-center items-center border border-slate-700 transition-all duration-300 hover:border-sky-500/50">
                <button 
                    class="play-btn bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75"
                    data-src="https://raw.githubusercontent.com/gabrielbailly/considera-misterios/main/audios/dolorosos.m4a"
                    data-title="Misterios Dolorosos">
                    Dolorosos
                </button>
            </div>

            <!-- Misterios Luminosos -->
            <div class="mystery-card bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col justify-center items-center border border-slate-700 transition-all duration-300 hover:border-sky-500/50">
                <button 
                    class="play-btn bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75"
                    data-src="https://raw.githubusercontent.com/gabrielbailly/considera-misterios/main/audios/luminosos.m4a"
                    data-title="Misterios Luminosos">
                    Luminosos
                </button>
            </div>

            <!-- Misterios Gloriosos -->
            <div class="mystery-card bg-slate-800 p-6 rounded-xl shadow-lg flex flex-col justify-center items-center border border-slate-700 transition-all duration-300 hover:border-sky-500/50">
                <button 
                    class="play-btn bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-4 rounded-lg transition-colors duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-sky-400 focus:ring-opacity-75"
                    data-src="https://raw.githubusercontent.com/gabrielbailly/considera-misterios/main/audios/gloriosos.m4a"
                    data-title="Misterios Gloriosos">
                    Gloriosos
                </button>
            </div>

        </main>

        <!-- Pie de página -->
        <footer class="mt-12 pt-8 border-t border-slate-700 text-center text-sm text-slate-400">
            <p class="mb-4">Grabación realizada por Gabriel Bailly-Bailliere Torres-Pardo.</p>
            <div>
                <h4 class="font-semibold text-slate-300 mb-2">Música de fondo utilizada</h4>
                <ul class="space-y-1">
                    <li>Ave Verum Corpus – Wolfgang Amadeus Mozart</li>
                    <li>Adagio for Strings – Samuel Barber</li>
                    <li>Concierto de Brandeburgo n.º 3 (Adagio) – Johann Sebastian Bach</li>
                    <li>Aleluya, del Oratorio El Mesías – Georg Friedrich Händel</li>
                </ul>
            </div>
        </footer>

    </div>

    <!-- Banner de Instalación PWA (para Android/Chrome) -->
    <div id="install-banner" class="hidden fixed bottom-0 left-0 right-0 bg-sky-600 text-white p-4 text-center flex justify-center items-center gap-4 z-50 shadow-lg">
        <p class="text-sm sm:text-base">Añadir a pantalla de inicio para acceso rápido.</p>
        <button id="install-button" class="bg-white text-sky-700 font-bold py-2 px-4 rounded-lg hover:bg-slate-200 transition-colors">
            Instalar
        </button>
    </div>

    <!-- Banner de Instalación PWA (para iOS/Safari) -->
    <div id="ios-install-banner" class="hidden fixed bottom-0 left-0 right-0 bg-slate-800 text-white p-4 text-center z-50 shadow-lg">
        <p class="text-sm sm:text-base">Para instalar, pulsa el botón <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block -mt-1" viewBox="0 0 20 20" fill="currentColor"><path d="M15 8a3 3 0 10-2.977-2.63l-4.94 2.47a3 3 0 100 4.319l4.94 2.47a3 3 0 10.895-1.789l-4.94-2.47a3.027 3.027 0 000-.74l4.94-2.47C13.456 7.68 14.19 8 15 8z" /></svg> Compartir y luego "Añadir a pantalla de inicio".</p>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Lógica del reproductor de audio (sin cambios)
            const audioPlayer = document.getElementById('main-audio-player');
            const nowPlaying = document.getElementById('now-playing');
            const playButtons = document.querySelectorAll('.play-btn');
            let currentPlayingButton = null;

            playButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const audioSrc = button.dataset.src;
                    if (button === currentPlayingButton) {
                        audioPlayer.pause();
                        return;
                    }
                    while (audioPlayer.firstChild) {
                        audioPlayer.removeChild(audioPlayer.firstChild);
                    }
                    const source = document.createElement('source');
                    source.src = audioSrc;
                    source.type = 'audio/mp4'; 
                    audioPlayer.appendChild(source);
                    audioPlayer.load();
                    audioPlayer.play().catch(e => console.error("Error al reproducir audio:", e));
                });
            });

            audioPlayer.addEventListener('play', () => {
                const currentSrc = audioPlayer.querySelector('source').src;
                const playingButton = Array.from(playButtons).find(btn => btn.dataset.src === currentSrc);
                if(playingButton && playingButton !== currentPlayingButton) {
                    if (currentPlayingButton) {
                        currentPlayingButton.classList.remove('bg-green-500', 'hover:bg-green-400');
                        currentPlayingButton.classList.add('bg-sky-600', 'hover:bg-sky-500');
                        currentPlayingButton.textContent = currentPlayingButton.dataset.title.split(' ')[1];
                        currentPlayingButton.closest('.mystery-card').classList.remove('ring-2', 'ring-sky-500');
                    }
                    playingButton.classList.remove('bg-sky-600', 'hover:bg-sky-500');
                    playingButton.classList.add('bg-green-500', 'hover:bg-green-400');
                    playingButton.textContent = 'Reproduciendo...';
                    playingButton.closest('.mystery-card').classList.add('ring-2', 'ring-sky-500');
                    nowPlaying.textContent = playingButton.dataset.title;
                    currentPlayingButton = playingButton;
                }
            });
            
            audioPlayer.addEventListener('pause', () => {
                if (currentPlayingButton) {
                    currentPlayingButton.classList.remove('bg-green-500', 'hover:bg-green-400');
                    currentPlayingButton.classList.add('bg-sky-600', 'hover:bg-sky-500');
                    currentPlayingButton.textContent = currentPlayingButton.dataset.title.split(' ')[1];
                    currentPlayingButton.closest('.mystery-card').classList.remove('ring-2', 'ring-sky-500');
                    currentPlayingButton = null;
                }
            });
            
            audioPlayer.addEventListener('ended', () => {
                nowPlaying.textContent = 'Selecciona un misterio';
            });

            audioPlayer.addEventListener('error', () => {
                nowPlaying.textContent = `Error al cargar el audio`;
                console.error(`No se pudo cargar el archivo de audio.`);
                 if (currentPlayingButton) {
                    currentPlayingButton.click();
                }
            });
        });

        // --- Registro del Service Worker para la PWA ---
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(registration => console.log('Service Worker registrado con éxito.'))
                    .catch(error => console.log('Error al registrar el Service Worker:', error));
            });
        }

        // --- Lógica para el banner de instalación de la PWA ---
        
        // Función para detectar si es un dispositivo iOS
        const isIOS = () => {
            const userAgent = window.navigator.userAgent.toLowerCase();
            return /iphone|ipad|ipod/.test(userAgent);
        }
        
        // Función para detectar si la app está en modo PWA (pantalla completa)
        const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);

        // Si es iOS y no está en modo PWA, muestra el banner de instrucciones para iOS
        if (isIOS() && !isInStandaloneMode()) {
            const iosInstallBanner = document.getElementById('ios-install-banner');
            iosInstallBanner.classList.remove('hidden');
        }

        // Lógica para Android/Chrome
        let deferredPrompt;
        const installBanner = document.getElementById('install-banner');
        const installButton = document.getElementById('install-button');

        window.addEventListener('beforeinstallprompt', (e) => {
            // Solo muestra el banner si no es iOS
            if (!isIOS()) {
                e.preventDefault();
                deferredPrompt = e;
                installBanner.classList.remove('hidden');
            }
        });

        if(installButton){
            installButton.addEventListener('click', (e) => {
                installBanner.classList.add('hidden');
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('El usuario aceptó instalar la PWA');
                    } else {
                        console.log('El usuario rechazó instalar la PWA');
                    }
                    deferredPrompt = null;
                });
            });
        }

        window.addEventListener('appinstalled', (evt) => {
            console.log('PWA fue instalada');
            installBanner.classList.add('hidden');
            deferredPrompt = null;
        });
    </script>
</body>
</html>
